<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Qadri Shop</title>
    <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
    
    <!-- Open Graph Meta Tags -->
    <meta property="og:title" content="Qadri Shop - Product Name">
    <meta property="og:description" content="Product Description">
    <meta property="og:image" content="URL_TO_PRODUCT_IMAGE">
    <meta property="og:url" content="URL_TO_PRODUCT">
    <meta property="og:type" content="website">
    <!-- Twitter Card Meta Tags (optional, for Twitter sharing) -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:title" content="Qadri Shop - Product Name">
    <meta name="twitter:description" content="Product Description">
    <meta name="twitter:image" content="URL_TO_PRODUCT_IMAGE">

    <style>
        :root {
            --primary-color: #6a11cb;
            --primary-dark-color: #2575fc;
            --success-color: #28a745; --success-dark-color: #218838;
            --danger-color: #e53935;  --danger-dark-color: #c62828;
            --warning-color: #ffc107; --warning-dark-color: #e0a800;
            --light-gray: #f4f5f7;
            --dark-text: #333;
            --nav-height: 60px;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            margin: 0;
            background-color: var(--light-gray);
        }
        .screen { display: none; padding-bottom: calc(var(--nav-height) + 80px); animation: fadeIn 0.3s; }
        .screen.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .header {
            padding: 10px 15px;
            background: linear-gradient(to right, var(--primary-color), var(--primary-dark-color));
            color: white;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            position: sticky; top: 0; z-index: 1000;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .header-title-group { display: flex; align-items: center; gap: 10px; }
        /* Logo link styling */
        .header .header-title-group > a {
            display: flex;
            align-items: center;
            text-decoration: none; /* Remove underline from link */
            color: white; /* Ensure text color is white */
        }
        .header #website-logo { height: 35px; width: 35px; border-radius: 5px; object-fit: cover; background-color: #fff; cursor: pointer; } 
        .header .title { font-size: 20px; font-weight: bold; margin: 0; }
        #whatsapp-icon { background: #25D366; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        #whatsapp-icon svg { width: 20px; height: 20px; color: white; }
        .search-container { display: flex; gap: 10px; align-items: center; }
        .header .search-bar { flex-grow: 1; padding: 8px 12px; border: none; border-radius: 20px; font-size: 14px; }
        .header .sort-filter { padding: 8px; border: none; border-radius: 20px; font-size: 12px; background-color: rgba(255,255,255,0.2); color: white; }
        .header .sort-filter option { color: black; }
        .back-icon { font-size: 24px; cursor: pointer; color: white; }
        .header .title.details-title { color: white; }
        .form-container { padding: 20px; }
        .form-container input { width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; font-size: 16px; }
        .btn { width: 100%; padding: 12px; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; margin-top: 10px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); transition: all 0.2s ease; }
        .btn:disabled { background: #b0bec5 !important; cursor: not-allowed; box-shadow: none; }
        .btn:active { transform: translateY(1px); box-shadow: 0 2px 3px rgba(0,0,0,0.15); }
        .primary-btn { background: linear-gradient(to right, #007bff, #0056b3); }
        .danger-btn { background: var(--danger-color); } .danger-btn:hover { background: var(--danger-dark-color); }
        .success-btn { background: var(--success-color); } .success-btn:hover { background: var(--success-dark-color); }
        .warning-btn { background: var(--warning-color); color: #212529; } .warning-btn:hover { background: var(--warning-dark-color); }
        .fixed-bottom-btn { position: fixed; bottom: calc(var(--nav-height) + 10px); left: 15px; width: calc(100% - 30px); z-index: 999; }
        .empty-cart { text-align: center; padding: 50px; color: #777; }
        .toggle-form { text-align: center; margin-top: 15px; color: var(--primary-color); cursor: pointer; }
        .bottom-nav { position: fixed; bottom: 0; width: 100%; background: #fff; border-top: 1px solid #ddd; display: flex; justify-content: space-around; z-index: 1000; height: var(--nav-height); align-items: center;}
        .nav-item { cursor: pointer; text-align: center; color: #777; transition: color 0.2s; flex: 1; padding: 5px 0; position: relative; }
        .nav-item.active { color: var(--primary-dark-color); font-weight: bold; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 2px; }
        
        .cart-badge {
            position: absolute;
            top: 2px;
            right: calc(50% - 25px);
            background-color: var(--danger-color);
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            font-size: 11px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid white;
            display: none;
        }
        
        .home-section-title { font-size: 18px; font-weight: bold; color: var(--dark-text); padding: 15px 15px 0 15px; margin: 10px 0 0 0; }
        .slider-container { position: relative; width: calc(100% - 30px); margin: 15px auto; overflow: hidden; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
        .slider-wrapper { display: flex; transition: transform 0.5s ease-in-out; }
        .slider-wrapper img { width: 100%; flex-shrink: 0; display: block; height: 180px; object-fit: cover; }
        .slider-dots { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; }
        .dot { height: 8px; width: 8px; margin: 0 4px; background-color: rgba(255,255,255,0.5); border-radius: 50%; display: inline-block; cursor: pointer; transition: all 0.3s; }
        .dot.active { background-color: #fff; width: 20px; }
        .category-container { display: flex; overflow-x: auto; padding: 10px 15px; background-color: transparent; align-items: center;}
        .category-item { text-align: center; margin-right: 15px; flex-shrink: 0; cursor: pointer; }
        .category-item img { width: 60px; height: 60px; border-radius: 50%; object-fit: cover; border: 3px solid #fff; box-shadow: 0 4px 8px rgba(0,0,0,0.15);}
        .category-item p { margin-top: 5px; font-size: 12px; color: var(--dark-text); font-weight: 500;}
        .product-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 15px; }
        .product-card { background: #fff; border-radius: 12px; box-shadow: 0 4px 12px rgba(41, 41, 41, 0.08); overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 6px 16px rgba(0,0,0,0.12); }
        .product-card .product-image-container { position: relative; cursor: pointer; height: 150px; padding: 5px; display:flex; align-items:center; justify-content:center; }
        .product-card img { max-width: 100%; max-height: 100%; object-fit: contain; }
        .product-card-info { padding: 12px; }
        .product-title-row { display: flex; justify-content: space-between; align-items: center; } /* Flexbox added here */
        .product-card h3 { font-size: 14px; margin: 0 0 5px 0; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--dark-text); font-weight: 600; }
        .product-card .share-icon-btn { /* Added class name */
            font-size: 20px; 
            color: #ccc; 
            cursor: pointer; 
            margin-left: 5px; 
            display: inline-block; 
            background: none; 
            border: none; 
            padding: 0; /* Remove padding */
            line-height: 1; /* Ensure it doesn't affect alignment */
        }
        .product-card .share-icon-btn svg {
            width: 20px; /* Make SVG size consistent */
            height: 20px;
            fill: currentColor; /* Inherit color */
        }
        .product-card .fav-icon { font-size: 20px; color: #ccc; cursor: pointer; }
        .product-card .fav-icon.favorited { color: red; }
        .product-card p { font-size: 16px; font-weight: bold; margin: 0; color: var(--primary-color); }
        .details-container { background: white; border-radius: 20px 20px 0 0; margin-top: -20px; position: relative; z-index: 10; padding-top: 10px;}
        .product-image-slider { display: flex; overflow-x: auto; scroll-snap-type: x mandatory; background: white; padding: 10px 0;}
        .product-image-slider img { width: 100%; height: 300px; object-fit: contain; scroll-snap-align: center; }
        .details-content { padding: 20px; }
        .details-title-row { display: flex; justify-content: space-between; align-items: center; }
        .details-title-row h2 { margin: 0; font-size: 24px; font-weight: 700; color: var(--dark-text); }
        .details-price { font-size: 22px; font-weight: bold; color: var(--success-color); }
        .size-selector { margin: 20px 0; }
        .size-selector button { padding: 8px 15px; margin-right: 10px; border: 1px solid #ccc; background: #fff; border-radius: 5px; cursor: pointer; }
        .size-selector button.selected { background: var(--primary-color); color: #fff; border-color: var(--primary-color); }
        .description { margin: 20px 0; line-height: 1.6; color: #555; }
        .quantity-selector { display: flex; align-items: center; gap: 15px; margin: 20px 0; }
        .quantity-selector button { width: 30px; height: 30px; border-radius: 50%; border: 1px solid var(--primary-color); background: white; color: var(--primary-color); font-size: 18px; font-weight: bold; cursor: pointer;}
        .quantity-selector span { font-size: 18px; font-weight: bold; min-width: 20px; text-align: center;}
        .profile-header { display: flex; align-items: center; background: #fff; padding: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .profile-avatar { 
            width: 50px; height: 50px; border-radius: 50%; 
            background: var(--light-gray); 
            color: var(--primary-color); 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            font-size: 22px; 
            font-weight: bold; 
            margin-right: 15px; 
            object-fit: cover;
        }
        .profile-details h3 { margin: 0; font-size: 18px; }
        .profile-menu-cards { padding: 20px; }
        .profile-card { display: flex; align-items: center; background: #fff; border-radius: 8px; padding: 15px; margin-bottom: 15px; cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
        .profile-card-icon { width: 24px; height: 24px; margin-right: 15px; color: var(--primary-color); }
        .profile-card-text { font-size: 16px; font-weight: 500; flex-grow: 1; }
        .profile-card.logout .profile-card-text, .profile-card.logout .profile-card-icon { color: var(--danger-color); }
        .cart-item { display: flex; background: #fff; margin: 10px 15px; padding: 10px; border-radius: 8px; align-items: center; position: relative; }
        .cart-item img { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; margin-right: 15px; }
        .cart-item-info { flex-grow: 1; }
        .cart-item-quantity { font-size: 14px; color: #555; }
        .cart-item-remove-btn { position: absolute; top: 10px; right: 10px; background: none; border: none; font-size: 20px; color: #aaa; cursor: pointer; }
        .order-tabs { display: flex; background-color: #fff; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .tab-item { flex: 1; text-align: center; padding: 15px; cursor: pointer; font-weight: 500; color: #777; border-bottom: 3px solid transparent; }
        .tab-item.active { color: var(--primary-dark-color); border-bottom-color: var(--primary-dark-color); }
        .order-list { display: none; padding: 0 15px; }
        .order-list.active { display: block; }
        .order-card { background: #fff; border-radius: 8px; margin: 15px 0; padding: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .order-card-header { display: flex; justify-content: space-between; font-size: 14px; color: #555; margin-bottom: 15px; }
        .order-card-header .order-id { font-weight: bold; color: #333; }
        .order-card-body { display: flex; gap: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .order-card-body img { width: 70px; height: 70px; border-radius: 5px; object-fit: contain; }
        .order-card-details { flex-grow: 1; }
        .order-card-details h4 { margin: 0 0 5px; font-size: 16px; }
        .order-card-details p { margin: 0; font-size: 14px; color: #777; }
        .order-status-tracker { display: flex; justify-content: space-between; margin-top: 15px; position: relative; }
        .order-status-tracker::before { content: ''; position: absolute; top: 10px; left: 15%; right: 15%; height: 2px; background-color: #e0e0e0; z-index: 0; }
        .status-step { text-align: center; z-index: 1; }
        .status-dot { width: 20px; height: 20px; border-radius: 50%; background-color: #e0e0e0; margin: 0 auto 5px; position: relative; border: 3px solid #fff; }
        .status-step.active .status-dot { background-color: var(--success-color); }
        .status-dot::after { content: '✓'; color: #fff; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 12px; font-weight: bold; opacity: 0; }
        .status-step.active .status-dot::after { opacity: 1; }
        .status-label { font-size: 12px; color: #999; }
        .status-step.active .status-label { color: #333; }
        .order-card-footer { margin-top: 15px; }
        .order-cancel-btn { width: 100%; background: var(--danger-color); color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; font-size: 14px; font-weight: bold; }
        #delivery-address-list .address-card { background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 15px; display: flex; align-items: flex-start; gap: 15px; cursor: pointer; }
        #delivery-address-list input[type="radio"] { margin-top: 5px; width: 20px; height: 20px; }
        .address-details { flex-grow: 1; }
        .address-details strong { font-size: 16px; display: block; margin-bottom: 5px; }
        .address-details p { font-size: 14px; color: #555; margin: 3px 0; }
        #delivery-address-screen .btn { background: #007bff; }
        .payment-options h4 { font-size: 18px; margin-top: 25px; margin-bottom: 10px; }
        .payment-option { display: flex; align-items: center; background: #fff; border: 1px solid #e0e0e0; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; }
        .payment-option.selected { border-color: var(--primary-dark-color); background-color: #e9f5ff; }
        .payment-option svg { margin-right: 15px; color: #555; }
        .payment-option span { flex-grow: 1; font-weight: 500; }
        .payment-option .radio-check { width: 20px; height: 20px; border-radius: 50%; border: 2px solid #ccc; position: relative; }
        .payment-option.selected .radio-check { border-color: var(--primary-dark-color); }
        .payment-option.selected .radio-check::after { content: ''; width: 10px; height: 10px; background-color: var(--primary-dark-color); border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }

        /* Custom Share Dialog Styles */
        .share-dialog-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none; /* Initially hidden */
            justify-content: center;
            align-items: center;
            z-index: 2000;
            animation: fadeIn 0.3s;
        }
        .share-dialog-box {
            background: #fff;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            width: 80%;
            max-width: 320px;
            animation: scaleUp 0.3s;
        }
        .share-dialog-box h3 {
            margin-top: 0;
            font-size: 20px;
            color: var(--dark-text);
        }
        .share-dialog-box p {
            margin-bottom: 25px;
            color: #555;
            line-height: 1.5;
        }
        .share-dialog-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .share-dialog-box button {
            width: 100%;
        }
        .share-dialog-box .btn-whatsapp {
            background: #25D366; /* WhatsApp Green */
        }
        .share-dialog-box .btn-copy-link {
            background: #007bff; /* Primary Blue for copy */
        }
        .share-dialog-box .btn-cancel {
            background: #eee;
            color: #333;
            border: 1px solid #ccc;
        }
        @keyframes scaleUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* Dialog for general messages (like errors, success) */
        .dialog-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 2000; animation: fadeIn 0.3s; }
        .dialog-box { background: #fff; padding: 25px; border-radius: 15px; text-align: center; box-shadow: 0 5px 20px rgba(0,0,0,0.3); width: 80%; max-width: 320px; animation: scaleUp 0.3s; }
        #dialog-icon { margin: 0 auto 15px; }
        #dialog-icon svg { width: 50px; height: 50px; }
        .dialog-box h3 { margin-top: 0; font-size: 20px; color: var(--dark-text); }
        .dialog-box p { margin-bottom: 25px; color: #555; line-height: 1.5; }
        .dialog-buttons { display: flex; flex-direction: column; gap: 10px; }
        .dialog-box button { width: 100%; }
        .dialog-box #dialog-secondary-btn { background: #eee; color: #333; border: 1px solid #ccc; }

    </style>
</head>
<body>
    <div id="home-screen" class="screen active"> 
        <div class="header"> 
            <div class="header-top">
                <div class="header-title-group">
                    <!-- Link the logo to the website's base URL -->
                    <a id="website-logo-link" href="#" style="text-decoration: none;">
                        <img id="website-logo" src="" alt="Logo">
                    </a>
                    <span id="website-title" class="title">Qadri Shop</span> 
                </div>
                <a id="whatsapp-icon" href="#" target="_blank" style="display: none;">
                    <svg viewBox="0 0 32 32"><path fill="currentColor" d=" M19.11 17.205c-.372 0-1.088 1.39-1.518 1.39a.63.63 0 0 1-.315-.1c-.802-.402-1.504-.817-2.163-1.447-.545-.516-1.146-1.29-1.46-1.963a.426.426 0 0 1-.073-.215c0-.33.99-.945.99-1.49 0-.143-.73-2.09-.832-2.335-.143-.372-.214-.487-.6-.487-.187 0-.36-.044-.53-.044-.302 0-.53.115-.746.315-.688.645-1.032 1.318-1.06 2.264v.114c-.015.99.472 1.977 1.017 2.78 1.23 1.82 2.506 3.41 4.554 4.34.616.287 2.035.888 2.722.888.817 0 2.15-.515 2.478-1.318.12-.302.214-.73.214-1.064v-.044c-.03-.515-.13-.515-.354-.515z M15.01 3.316a11.56 11.56 0 0 0-8.423 4.244c-2.327 2.326-3.736 5.43-3.736 8.76 0 5.093 3.217 9.53 7.82 11.06l-1.396 2.823 4.144-2.132a11.6 11.6 0 0 0 7.032 2.21H16.3c6.99 0 12.67-5.67 12.67-12.64a12.63 12.63 0 0 0-12.67-12.67z"></path></svg>
                </a>
            </div>
            <div class="search-container">
                <input type="search" id="search-bar" class="search-bar" placeholder="Search for products...">
                <select id="sort-filter" class="sort-filter">
                    <option value="default">Sort by</option>
                    <option value="price_asc">Price: Low to High</option>
                    <option value="price_desc">Price: High to Low</option>
                </select>
            </div>
        </div> 
        <div class="slider-container" id="banner-container"><div class="slider-wrapper" id="banner-wrapper"></div><div class="slider-dots" id="banner-dots"></div></div>
        <h2 class="home-section-title">Shop by Category</h2>
        <div class="category-container" id="category-container"></div> 
        <h2 class="home-section-title">All Products</h2>
        <div class="product-grid" id="product-grid"></div> 
    </div>
    
    <div id="product-details-screen" class="screen"> 
        <div class="header"> 
            <span class="back-icon">←</span> 
            <span class="title details-title">Product Details</span> 
        </div> 
        <div id="product-details-content"></div> 
        <button id="add-to-cart-btn" class="btn success-btn fixed-bottom-btn">Add to Cart</button> 
    </div>

    <div id="cart-screen" class="screen"> 
        <div class="header">
            <span class="back-icon">←</span>
            <span class="title details-title">My Cart</span>
        </div> 
        <div id="cart-items-container"></div> 
        <button id="buy-now-btn" class="btn warning-btn" style="position: fixed; bottom: calc(var(--nav-height) + 10px); left: 15px; width: calc(100% - 30px); z-index: 999; display:none;">Buy Now</button> 
    </div>
    
    <div id="profile-screen" class="screen" style="padding-bottom: var(--nav-height);">
        <!-- Login View (shown when not logged in) -->
        <div id="login-view" style="display: block;"> <!-- Initially block -->
             <div class="header" style="position:relative;"><span class="title details-title">Login or Sign Up</span></div>
            <div class="form-container" id="login-form"> <h2>Login</h2> <input type="email" id="login-email" placeholder="Email"> <input type="password" id="login-password" placeholder="Password"> <button class="btn primary-btn" id="login-btn">Login</button> <p class="toggle-form" onclick="toggleAuthForms()">Don't have an account? Sign Up</p> </div>
            <div class="form-container" id="signup-form" style="display: none;"> <h2>Sign Up</h2> <input type="text" id="signup-name" placeholder="Full Name"> <input type="email" id="signup-email" placeholder="Email"> <input type="password" id="signup-password" placeholder="Password"> <button class="btn primary-btn" id="signup-btn">Sign Up</button> <p class="toggle-form" onclick="toggleAuthForms()">Already have an account? Login</p> </div>
        </div>
        
        <!-- Profile View (shown when logged in) -->
        <div id="profile-view" style="display: none;"> <!-- Initially hidden -->
            <div class="header" style="position:relative;">
                <span class="title details-title">My Profile</span>
            </div>
            <div id="profile-info-header" class="profile-header"> 
                <!-- Avatar will show user's initial if no photoURL -->
                <div id="profile-avatar-img" class="profile-avatar"></div> 
                <div id="profile-details" class="profile-details"></div> 
            </div>
            <div class="profile-menu-cards">
                <div class="profile-card" id="profile-my-orders"> <svg class="profile-card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg> <span class="profile-card-text">My Orders</span> </div>
                <div class="profile-card" id="profile-my-favorites"> <svg class="profile-card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 016.364 0L12 7.5l1.318-1.182a4.5 4.5 0 116.364 6.364L12 21l-7.682-7.682a4.5 4.5 0 010-6.364z"></path></svg> <span class="profile-card-text">My Favorites</span> </div>
                <div class="profile-card" id="profile-my-addresses"> <svg class="profile-card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a2 2 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/></svg> <span class="profile-card-text">My Addresses</span> </div>
                <div class="profile-card" id="profile-edit-profile"> <svg class="profile-card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21H3v-3.5L16.732 3.732z"/></svg> <span class="profile-card-text">Edit Profile</span> </div>
                <div id="logout-btn" class="profile-card logout"> <svg class="profile-card-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"/></svg> <span class="profile-card-text">Logout</span> </div>
            </div>
        </div>
    </div>
    
    <div id="edit-profile-screen" class="screen">
        <div class="header"><span class="back-icon">←</span><span class="title details-title">Edit Profile</span></div>
        <div class="form-container">
            <h3>Update Information</h3> 
            <input type="text" id="edit-name" placeholder="Full Name"> 
            <input type="email" id="edit-email" placeholder="Email" disabled style="background:#eee;"> 
            <button id="update-name-btn" class="btn primary-btn">Update Name</button>
            <hr style="margin: 30px 0;">
            <h3>Change Password</h3> 
            <input type="password" id="new-password" placeholder="New Password"> 
            <button id="change-password-btn" class="btn primary-btn">Update Password</button>
        </div>
    </div>
    
    <div id="favorites-screen" class="screen"><div class="header"><span class="back-icon">←</span><span class="title details-title">My Favorites</span></div><div id="favorites-grid" class="product-grid"></div></div>
    <div id="my-orders-screen" class="screen"><div class="header"><span class="back-icon">←</span><span class="title details-title">My Orders</span></div><div class="order-tabs"><div id="active-orders-tab" class="tab-item active" onclick="switchOrderTab('active')">Active</div><div id="history-orders-tab" class="tab-item" onclick="switchOrderTab('history')">History</div></div><div id="active-orders-list" class="order-list active"></div><div id="history-orders-list" class="order-list"></div></div>
    <div id="address-screen" class="screen"><div class="header"><span class="back-icon">←</span><span class="title details-title">My Addresses</span></div><div id="address-list-container" class="form-container"></div><button id="add-new-address-btn1" class="btn primary-btn fixed-bottom-btn">Add New Address</button></div>
    <div id="add-address-screen" class="screen"><div class="header"><span class="back-icon">←</span><span class="title details-title">Add New Address</span></div><form class="form-container" id="add-address-form"><input type="text" id="addr-name" placeholder="Full Name" required><div class="mobile-input-group"> <span>+91</span> <input type="tel" id="addr-mobile" placeholder="10-digit Mobile Number" required pattern="[6-9]{1}[0-9]{9}"> </div><input type="text" id="addr-pincode" placeholder="Pincode (6 digits)" required maxlength="6" pattern="\d{6}"><input type="text" id="addr-area" placeholder="Area, Colony, Street" required><input type="text" id="addr-village" placeholder="Flat No., Building, Village" required><input type="text" id="addr-district" placeholder="District" required><input type="text" id="addr-state" placeholder="State" required></form><button id="save-address-btn" class="btn primary-btn" style="position:fixed; bottom:var(--nav-height); left:15px; width:calc(100% - 30px);">Save Address</button></div>
    
    <div id="delivery-address-screen" class="screen">
        <div class="header"><span class="back-icon">←</span><span class="title details-title">Select Address & Payment</span></div>
        <div class="form-container">
            <div id="delivery-address-list"></div>
            <button id="add-new-address-btn2" style="margin-top: 5px;" class="btn">Add New Address</button>
            <div class="payment-options">
                <h4>Payment Mode</h4>
                <div class="payment-option selected" data-value="COD">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 9.5a2.5 2.5 0 0 1-5 0M2 6h20M2 10h20M2 14h20M2 18h20M7 2v4M17 2v4"/></svg>
                    <span>Cash on Delivery</span>
                    <div class="radio-check"></div>
                </div>
                <div class="payment-option" data-value="ONLINE">
                     <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect><line x1="1" y1="10" x2="23" y2="10"></line></svg>
                    <span>Pay Online</span>
                    <div class="radio-check"></div>
                </div>
            </div>
        </div>
        <button id="submit-order-btn" class="btn warning-btn fixed-bottom-btn">Place Order</button>
    </div>
    
    <!-- Custom Share Dialog -->
    <div id="share-dialog-overlay" class="share-dialog-overlay">
        <div class="share-dialog-box">
            <h3>Share Product</h3>
            <p>Choose how to share this link:</p>
            <div class="share-dialog-buttons">
                <button id="share-whatsapp-btn" class="btn btn-whatsapp">Share on WhatsApp</button>
                <button id="share-copy-link-btn" class="btn btn-copy-link">Copy Link</button>
            </div>
            <button id="share-cancel-btn" class="btn btn-cancel" style="margin-top: 10px;">Cancel</button>
        </div>
    </div>
    
    <!-- General Dialog for messages -->
    <div id="dialog-overlay" class="dialog-overlay">
        <div class="dialog-box">
            <div id="dialog-icon"></div>
            <h3 id="dialog-title"></h3>
            <p id="dialog-message"></p>
            <div class="dialog-buttons">
                <button id="dialog-primary-btn" class="primary-btn"></button>
                <button id="dialog-secondary-btn"></button>
            </div>
            <button id="dialog-single-btn" class="btn primary-btn"></button>
        </div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item active" onclick="showScreen('home-screen')"><svg fill="currentColor" viewBox="0 0 20 20"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z"></path></svg><div>Home</div></div>
        <div class="nav-item" onclick="showScreen('cart-screen')">
            <span id="cart-badge" class="cart-badge">0</span>
            <svg fill="currentColor" viewBox="0 0 20 20"><path d="M3 1a1 1 0 000 2h1.22l.305 1.222a.997.997 0 00.01.042l1.358 5.43-.893.892C3.74 11.846 4.632 14 6.414 14H15a1 1 0 000-2H6.414l1-1H14a1 1 0 00.894-.553l3-6A1 1 0 0017 3H6.28l-.31-1.243A1 1 0 005 1H3zM16 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM6.5 18a1.5 1.5 0 100-3 1.5 1.5 0 000 3z"></path></svg>
            <div>Cart</div>
        </div>
        <div class="nav-item" onclick="showScreen('profile-screen')"><svg fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg><div>Profile</div></div>
    </div>
    
    <a id="floating-whatsapp-btn" href="#" target="_blank" style="display: none;">
        <svg viewBox="0 0 32 32"><path fill="currentColor" d=" M19.11 17.205c-.372 0-1.088 1.39-1.518 1.39a.63.63 0 0 1-.315-.1c-.802-.402-1.504-.817-2.163-1.447-.545-.516-1.146-1.29-1.46-1.963a.426.426 0 0 1-.073-.215c0-.33.99-.945.99-1.49 0-.143-.73-2.09-.832-2.335-.143-.372-.214-.487-.6-.487-.187 0-.36-.044-.53-.044-.302 0-.53.115-.746.315-.688.645-1.032 1.318-1.06 2.264v.114c-.015.99.472 1.977 1.017 2.78 1.23 1.82 2.506 3.41 4.554 4.34.616.287 2.035.888 2.722.888.817 0 2.15-.515 2.478-1.318.12-.302.214-.73.214-1.064v-.044c-.03-.515-.13-.515-.354-.515z M15.01 3.316a11.56 11.56 0 0 0-8.423 4.244c-2.327 2.326-3.736 5.43-3.736 8.76 0 5.093 3.217 9.53 7.82 11.06l-1.396 2.823 4.144-2.132a11.6 11.6 0 0 0 7.032 2.21H16.3c6.99 0 12.67-5.67 12.67-12.64a12.63 12.63 0 0 0-12.67-12.67z"></path></svg>
    </a>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, updatePassword } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, push, query, equalTo, orderByChild, update, increment } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js";
        
        const firebaseConfig = { apiKey: "AIzaSyDOSPw7efhM3ffnit5wGzslnEmzjdcmjzo", authDomain: "qadri-shop.firebaseapp.com", databaseURL: "https://qadri-shop-default-rtdb.firebaseio.com", projectId: "qadri-shop", storageBucket: "qadri-shop.appspot.com", messagingSenderId: "45179387232", appId: "1:45179387232:web:7f6cabc9a2eb186a82f205" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        
        // Global variable to store website settings, now accessible to other functions
        let settings = {}; 
        
        let currentUser = null, currentProduct = null, allProducts = {}, userFavorites = [];
        let addressReturnScreen = 'profile-screen'; 
        let currentFilters = { search: '', sort: 'default', category: null }; // Added category filter

        function loadWebsiteSettings() {
            get(ref(db, 'settings')).then(snapshot => {
                if (snapshot.exists()) {
                    settings = snapshot.val(); // Store settings globally
                    document.title = settings.name || 'Qadri Shop';
                    document.getElementById('website-title').textContent = settings.name || 'Qadri Shop';
                    if (settings.logoUrl) document.getElementById('website-logo').src = settings.logoUrl;
                    
                    // Set the href for the website logo link
                    const logoLink = document.getElementById('website-logo').parentElement; // Get the parent <a> tag
                    if (logoLink && logoLink.tagName === 'A') {
                        // Construct the base URL dynamically
                        let baseUrl = window.location.origin;
                        // Get the current directory from the URL, if any
                        const pathSegments = window.location.pathname.split('/');
                        // Basic check to include directory if present, e.g., http://localhost:port/my-app/
                        if (pathSegments.length > 1 && pathSegments[1]) { 
                            baseUrl += '/' + pathSegments[1]; 
                        }
                        logoLink.href = baseUrl;
                    }

                    if (settings.whatsappNumber) {
                        const waIcon = document.getElementById('whatsapp-icon');
                        waIcon.href = `https://wa.me/${settings.whatsappNumber}`;
                        waIcon.style.display = 'flex';
                    } else {
                        document.getElementById('whatsapp-icon').style.display = 'none';
                    }
                }
            }).catch(e => console.error("Could not load settings. Check Firebase Rules.", e));
        }
        
        const screens = document.querySelectorAll('.screen');
        const navItems = document.querySelectorAll('.nav-item');
        window.showScreen = (screenId) => { 
            screens.forEach(s => s.classList.remove('active')); 
            const screen = document.getElementById(screenId);
            if(screen) {
                screen.classList.add('active'); 
                window.scrollTo(0, 0);
            }
            navItems.forEach(item => {
                item.classList.remove('active');
                if ((screenId === 'home-screen' && item.textContent.includes('Home')) ||
                    (screenId === 'cart-screen' && item.textContent.includes('Cart')) ||
                    (screenId === 'profile-screen' && item.textContent.includes('Profile'))) {
                    item.classList.add('active');
                }
            });
        };
        
        // --- Dialog Functions ---
        const dialogOverlay = document.getElementById('dialog-overlay');
        const DIALOG_ICONS = {
            success: `<svg style="color: var(--success-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`,
            confirm: `<svg style="color: var(--warning-color);" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>`
        };
        function showDialog({ type, title, message, primaryBtnText, onPrimaryClick, secondaryBtnText, onSecondaryClick }) {
            document.getElementById('dialog-icon').innerHTML = DIALOG_ICONS[type] || '';
            document.getElementById('dialog-title').textContent = title;
            document.getElementById('dialog-message').textContent = message;
            const pBtn = document.getElementById('dialog-primary-btn'), sBtn = document.getElementById('dialog-secondary-btn'), singleBtn = document.getElementById('dialog-single-btn');
            const twoBtnContainer = document.querySelector('.dialog-buttons');
            
            singleBtn.style.display = 'none';
            twoBtnContainer.style.display = 'none';

            if (primaryBtnText && secondaryBtnText) {
                twoBtnContainer.style.display = 'flex';
                pBtn.textContent = primaryBtnText; sBtn.textContent = secondaryBtnText;
                pBtn.onclick = () => { onPrimaryClick(); closeDialog(); };
                sBtn.onclick = () => { if(onSecondaryClick) onSecondaryClick(); closeDialog(); };
            } else if (primaryBtnText) {
                singleBtn.style.display = 'block'; singleBtn.textContent = primaryBtnText;
                singleBtn.onclick = () => { onPrimaryClick(); closeDialog(); };
            }
            dialogOverlay.style.display = 'flex';
        }
        function closeDialog() { dialogOverlay.style.display = 'none'; }
        // --- End Dialog Functions ---

        // --- Share Dialog Functions ---
        const shareDialogOverlay = document.getElementById('share-dialog-overlay');
        const shareWhatsappBtn = document.getElementById('share-whatsapp-btn');
        const shareCopyLinkBtn = document.getElementById('share-copy-link-btn');
        const shareCancelBtn = document.getElementById('share-cancel-btn');

        function showShareDialog(productId, productTitle) {
            // Dynamically construct the share URL, including product details for potential Open Graph tags
            const shareUrl = `${window.location.origin}${window.location.pathname}?product=${productId}`;
            
            // Set Open Graph Meta Tags for the product
            const product = allProducts[productId]; // Get product data
            if (product) {
                // Update meta tags for sharing preview
                document.querySelector('meta[property="og:title"]').setAttribute('content', product.title);
                document.querySelector('meta[property="og:description"]').setAttribute('content', product.description || '');
                document.querySelector('meta[property="og:image"]').setAttribute('content', product.imageUrls[0] || ''); // Assuming first image is the preview
                document.querySelector('meta[property="og:url"]').setAttribute('content', shareUrl);
                // Twitter Card meta tags
                document.querySelector('meta[name="twitter:title"]').setAttribute('content', product.title);
                document.querySelector('meta[name="twitter:description"]').setAttribute('content', product.description || '');
                document.querySelector('meta[name="twitter:image"]').setAttribute('content', product.imageUrls[0] || '');
            } else {
                // Reset to default if product not found or invalid
                document.querySelector('meta[property="og:title"]').setAttribute('content', 'Qadri Shop');
                document.querySelector('meta[property="og:description"]').setAttribute('content', 'Discover amazing products at Qadri Shop.');
                document.querySelector('meta[property="og:image"]').setAttribute('content', ''); // No default image, or a generic site image
                document.querySelector('meta[property="og:url"]').setAttribute('content', window.location.origin + window.location.pathname);
                document.querySelector('meta[name="twitter:title"]').setAttribute('content', 'Qadri Shop');
                document.querySelector('meta[name="twitter:description"]').setAttribute('content', 'Discover amazing products at Qadri Shop.');
                document.querySelector('meta[name="twitter:image"]').setAttribute('content', '');
            }

            // WhatsApp Sharing Logic
            shareWhatsappBtn.onclick = () => {
                if (settings.whatsappNumber) { // Check if whatsapp number is available globally
                    // Encode message and URL for safety and proper transmission
                    const encodedMessage = encodeURIComponent(`Check out this product from Qadri Shop: ${productTitle} ${shareUrl}`);
                    window.open(`https://wa.me/${settings.whatsappNumber}?text=${encodedMessage}`, '_blank');
                } else {
                    // Fallback or show a message if whatsapp number is not set
                    alert("WhatsApp number not configured. Please copy the link manually.");
                    prompt('Copy this link to share:', shareUrl); // Fallback prompt
                }
                closeShareDialog();
            };

            // Copy Link Logic
            shareCopyLinkBtn.onclick = async () => {
                try {
                    await navigator.clipboard.writeText(shareUrl);
                    alert('Link copied to clipboard!');
                } catch (err) {
                    console.error('Failed to copy link: ', err);
                    alert('Could not copy link. Please copy manually from the prompt.');
                    prompt('Copy this link to share:', shareUrl); // Fallback prompt
                }
                closeShareDialog();
            };

            shareCancelBtn.onclick = closeShareDialog;
            shareDialogOverlay.style.display = 'flex';
        }

        function closeShareDialog() {
            shareDialogOverlay.style.display = 'none';
            // Reset button click handlers to prevent multiple event listeners
            shareWhatsappBtn.onclick = null;
            shareCopyLinkBtn.onclick = null;
            shareCancelBtn.onclick = null;
        }
        // --- End Share Dialog Functions ---

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('profile-view').style.display = 'block'; // Show profile view
                document.getElementById('login-view').style.display = 'none'; // Hide login view
                onValue(ref(db, `users/${user.uid}`), (s) => { 
                    if(s.exists()) { 
                        const data = s.val(); const name = data.name || "User";
                        const avatarImg = document.getElementById('profile-avatar-img');
                        
                        // Display user's first initial if no photoURL is available
                        if (data.photoURL) {
                            avatarImg.src = data.photoURL; avatarImg.innerHTML = ''; avatarImg.style.background = 'none';
                        } else {
                            avatarImg.src = ''; 
                            avatarImg.style.background = 'var(--light-gray)';
                            avatarImg.innerHTML = `<div style="color:var(--primary-color); font-size: 22px; font-weight: bold;">${name.charAt(0).toUpperCase()}</div>`;
                        }
                        document.getElementById('profile-details').innerHTML = `<h3>${name}</h3>`; 
                    }
                });
                loadUserProfileForEdit(); loadAddresses(); loadCart(); loadFavorites(); loadMyOrders();
            } else {
                currentUser = null; userFavorites = [];
                document.getElementById('profile-view').style.display = 'none'; // Hide profile view
                document.getElementById('login-view').style.display = 'block'; // Show login view
                document.getElementById('cart-items-container').innerHTML = `<p class="empty-cart">Please login to view your cart.</p>`;
                const cartBadge = document.getElementById('cart-badge');
                cartBadge.style.display = 'none';
                cartBadge.textContent = '0';
            }
            loadInitialData();
        });
        
        document.getElementById('signup-btn').addEventListener('click', () => { const n = document.getElementById('signup-name').value, e = document.getElementById('signup-email').value, p = document.getElementById('signup-password').value; if (!n) return alert('Name required.'); createUserWithEmailAndPassword(auth, e, p).then(c => set(ref(db, `users/${c.user.uid}`), { name: n, email: e })).catch(err => alert(err.message)); });
        document.getElementById('login-btn').addEventListener('click', () => signInWithEmailAndPassword(auth, document.getElementById('login-email').value, document.getElementById('login-password').value).catch(err => alert(err.message)));
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));
        window.toggleAuthForms = () => { ['login-form', 'signup-form'].forEach(id => document.getElementById(id).style.display = document.getElementById(id).style.display === 'none' ? 'block' : 'none'); };
        
        function loadUserProfileForEdit() { if (!currentUser) return; get(ref(db, `users/${currentUser.uid}`)).then(s => { if (s.exists()) { const d = s.val(); document.getElementById('edit-name').value = d.name || ''; document.getElementById('edit-email').value = d.email || ''; } }); }
        
        document.getElementById('update-name-btn').addEventListener('click', async () => {
            if (!currentUser) return alert('You must be logged in.');
            const btn = document.getElementById('update-name-btn'); const name = document.getElementById('edit-name').value;
            if (!name) return alert('Name is required.');
            btn.disabled = true; btn.textContent = 'Saving...';
            try {
                await update(ref(db, `users/${currentUser.uid}`), { name: name });
                alert('Name updated successfully!');
            } catch(err) {
                alert('Failed to update name: ' + err.message);
            } finally {
                btn.disabled = false; btn.textContent = 'Update Name';
            }
        });
        document.getElementById('change-password-btn').addEventListener('click', () => { const p = document.getElementById('new-password').value; if (p.length < 6) return alert('Password too short.'); updatePassword(auth.currentUser, p).then(() => { alert('Password updated!'); document.getElementById('new-password').value = ''; }).catch(err => alert(`Error: ${err.message}`)); });

        function loadInitialData() { loadWebsiteSettings(); loadBanners(); loadCategories(); loadProducts(); }
        let slideIndex = 0, slideInterval; function showSlide(n) { const w = document.getElementById('banner-wrapper'), d = document.querySelectorAll('.dot'); if (!w || d.length === 0) return; if (n >= d.length) { slideIndex = 0; } if (n < 0) { slideIndex = d.length - 1; } w.style.transform = `translateX(${-slideIndex * 100}%)`; d.forEach(dot => dot.classList.remove('active')); if(d[slideIndex]) d[slideIndex].classList.add('active'); } function startSlider() { stopSlider(); slideInterval = setInterval(() => { slideIndex++; showSlide(slideIndex); }, 3000); } function stopSlider() { clearInterval(slideInterval); }
        function loadBanners() { onValue(ref(db, 'banners'), (s) => { const w = document.getElementById('banner-wrapper'), d = document.getElementById('banner-dots'); w.innerHTML = ''; d.innerHTML = ''; let i = 0; s.forEach(c => { w.innerHTML += `<img src="${c.val().imageUrl}">`; const dot = document.createElement('span'); dot.className = 'dot'; dot.onclick = () => { slideIndex = i; showSlide(slideIndex); stopSlider(); startSlider(); }; d.appendChild(dot); i++; }); if(i > 0) { showSlide(slideIndex); startSlider(); } }); }
        function loadCategories() { onValue(ref(db, 'categories'), s => { const c = document.getElementById('category-container'); c.innerHTML = `<div class="category-item" id="all-category-btn"><img src="https://i.ibb.co/9gY1P1j/all-items.png" alt="All"><p>All</p></div>`; s.forEach(child => { const cat = child.val(), el = document.createElement('div'); el.className = 'category-item'; el.innerHTML = `<img src="${cat.imageUrl}" alt="${cat.name}"><p>${cat.name}</p>`; el.onclick = () => filterProductsByCategory(cat.name); c.appendChild(el); }); document.getElementById('all-category-btn').onclick = () => { currentFilters.category = null; applyFiltersAndSort(); }; }); }
        function loadProducts() { 
            onValue(ref(db, 'products'), s => { 
                allProducts = s.val() || {}; 
                applyFiltersAndSort(); // Apply filters and sort after loading products
                checkUrlForProduct(); // This function is defined below
            }); 
        }
        
        // Function to check URL for product ID and open details
        function checkUrlForProduct() {
            const params = new URLSearchParams(window.location.search);
            const productId = params.get('product');
            if (productId && allProducts[productId]) {
                showProductDetails(productId, allProducts[productId]);
            }
        }

        // Function to share a product
        window.shareProduct = (productId, productTitle) => {
            // Show the custom share dialog
            showShareDialog(productId, productTitle);
        };

        function renderProducts(products, containerId = 'product-grid') { 
            const g = document.getElementById(containerId); g.innerHTML = ''; if(!products || Object.keys(products).length === 0) { g.innerHTML = `<p class="empty-cart">No products found.</p>`; return; } 
            for(const id in products) { const p = products[id], c = document.createElement('div'); c.className = 'product-card'; c.innerHTML = `<div class="product-image-container" data-product-id="${id}"><img src="${p.imageUrls[0]}"></div><div class="product-card-info"><div class="product-title-row"><h3>${p.title}</h3>
            <button class="share-icon-btn" onclick="event.stopPropagation(); shareProduct('${id}', '${p.title.replace(/'/g, "\\'")}');">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81 1.66 0 3-1.34 3-3s-1.34-3-3-3-3 1.34-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9c-1.66 0-3 1.34-3 3s1.34 3 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.16c-.05.21-.08.43-.08.65 0 1.66 1.34 3 3 3s3-1.34 3-3-1.34-3-3-3z"></path></svg>
            </button>
            <span class="fav-icon ${userFavorites.includes(id)?'favorited':''}" data-product-id="${id}">♥</span></div><p>₹${p.price}</p></div>`; g.appendChild(c); }
        }
        
        window.showProductDetails = (id, product) => {
            currentProduct = {id, ...product};
            const c = document.getElementById('product-details-content');
            const sH = (product.sizes && product.sizes.length > 0) ? `<div class="size-selector">${product.sizes.map(s => `<button class="size-btn">${s}</button>`).join('')}</div>` : '';
            const qS = `<div class="quantity-selector"><button id="qty-minus">-</button><span id="qty-value">1</span><button id="qty-plus">+</button></div>`;
            c.innerHTML = `<div class="product-image-slider">${product.imageUrls.map(u => `<img src="${u}">`).join('')}</div><div class="details-container"><div class="details-content"><div class="details-title-row"><h2>${product.title}</h2><span class="details-price">₹${product.price}</span></div>${sH}${qS}<div class="description"><h4>Description</h4><p>${product.description}</p></div></div></div>`;
            showScreen('product-details-screen'); 
            const qtyValue = document.getElementById('qty-value');
            document.getElementById('qty-plus').onclick = () => qtyValue.textContent = parseInt(qtyValue.textContent) + 1;
            document.getElementById('qty-minus').onclick = () => { let currentQty = parseInt(qtyValue.textContent); if (currentQty > 1) qtyValue.textContent = currentQty - 1; };
            document.querySelectorAll('.size-btn').forEach(b => b.onclick = e => { document.querySelectorAll('.size-btn').forEach(btn => btn.classList.remove('selected')); e.target.classList.add('selected'); }); 
        };

        document.getElementById('add-to-cart-btn').addEventListener('click', async () => {
            if(!currentUser) return alert("Please login first.");
            const size = document.querySelector('.size-btn.selected')?.innerText;
            if (currentProduct.sizes && currentProduct.sizes.length > 0 && !size) return alert('Please select a size.');
            const quantity = parseInt(document.getElementById('qty-value').textContent);
            const cartItemRef = ref(db, `carts/${currentUser.uid}/${currentProduct.id}`);
            const snapshot = await get(cartItemRef);
            if (snapshot.exists()) {
                await update(cartItemRef, { quantity: increment(quantity) });
            } else {
                await set(cartItemRef, { ...currentProduct, selectedSize: size, quantity: quantity, dateAdded: Date.now() });
            }
            showDialog({ type: "success", title: "Success!", message: "Product added to cart.", primaryBtnText: "OK", onPrimaryClick: () => {} });
        });

        function loadCart() { 
            if(!currentUser) return; 
            onValue(ref(db, `carts/${currentUser.uid}`), s => { 
                const c = document.getElementById('cart-items-container'), btn = document.getElementById('buy-now-btn'); 
                const cartBadge = document.getElementById('cart-badge');
                c.innerHTML = ''; 

                if(!s.exists()){ 
                    c.innerHTML = `<p class="empty-cart">Cart is empty.</p>`; 
                    btn.style.display='none';
                    cartBadge.style.display = 'none';
                    cartBadge.textContent = '0';
                    return;
                }
                let total = 0;
                const cartData = s.val();
                const itemCount = Object.keys(cartData).length;

                if (itemCount > 0) {
                    cartBadge.style.display = 'flex';
                    cartBadge.textContent = itemCount;
                } else {
                    cartBadge.style.display = 'none';
                }

                Object.keys(cartData).forEach(key => {
                    const i = cartData[key];
                    const itemTotal = (i.price || 0) * (i.quantity || 1);
                    const el = document.createElement('div'); el.className='cart-item'; 
                    el.innerHTML = `<img src="${i.imageUrls[0]}"><div class="cart-item-info"><h4>${i.title} ${i.selectedSize?`(${i.selectedSize})`:''}</h4><p class="cart-item-quantity">Qty: ${i.quantity}</p><p>₹${itemTotal}</p></div><button class="cart-item-remove-btn" data-product-id="${key}">×</button>`; 
                    total += itemTotal;
                    c.appendChild(el); 
                });

                btn.style.display='block'; btn.textContent=`Buy Now (Total: ₹${total})`; 
            });
        }
        function removeFromCart(productId) {
            if (!currentUser) return;
            showDialog({
                type: 'confirm',
                title: 'Remove Item',
                message: 'Are you sure you want to remove this item from your cart?',
                primaryBtnText: 'Remove',
                onPrimaryClick: () => {
                    set(ref(db, `carts/${currentUser.uid}/${productId}`), null);
                },
                secondaryBtnText: 'Cancel'
            });
        }
        document.getElementById('cart-items-container').addEventListener('click', e => {
            if (e.target.classList.contains('cart-item-remove-btn')) {
                removeFromCart(e.target.dataset.productId);
            }
        });
        
        function loadFavorites() { if (!currentUser) return; onValue(ref(db, `favorites/${currentUser.uid}`), s => { userFavorites = s.exists() ? Object.keys(s.val()) : []; applyFiltersAndSort(); }); }
        function toggleFavorite(productId) { if (!currentUser) { return alert("Please login to save favorites."); } const favRef = ref(db, `favorites/${currentUser.uid}/${productId}`); get(favRef).then(s => { set(favRef, s.exists() ? null : true) }); }
        function loadAndShowFavoritesScreen() { if (!currentUser) return; const favoritedProducts = {}; userFavorites.forEach(id => { if (allProducts[id]) { favoritedProducts[id] = allProducts[id]; } }); renderProducts(favoritedProducts, 'favorites-grid'); showScreen('favorites-screen'); }
        
        function openAddressScreen(returnTo) { addressReturnScreen = returnTo; showScreen('address-screen'); }
        function openAddAddressScreen(returnTo) { addressReturnScreen = returnTo; showScreen('add-address-screen'); }

        document.getElementById('save-address-btn').addEventListener('click', () => {
            if (!currentUser) {
                return alert('Please log in to save an address.');
            }
            const mobile = document.getElementById('addr-mobile').value; 
            const mobileRegex = /^[6-9]\d{9}$/; 
            if (!mobileRegex.test(mobile)) { 
                return alert('Please enter a valid 10-digit mobile number.'); 
            } 
            const address = { 
                name: document.getElementById('addr-name').value, 
                mobile: mobile, 
                pincode: document.getElementById('addr-pincode').value, 
                area: document.getElementById('addr-area').value, 
                village: document.getElementById('addr-village').value, 
                district: document.getElementById('addr-district').value, 
                state: document.getElementById('addr-state').value 
            }; 
            if (Object.values(address).some(f => !f)) return alert('All fields are required.'); 
            set(push(ref(db, `users/${currentUser.uid}/addresses`)), address).then(() => { 
                alert('Address saved!'); 
                document.getElementById('add-address-form').reset(); 
                showScreen(addressReturnScreen); 
            }); 
        });
        
        function loadAddresses() { 
            if (!currentUser) return; 
            onValue(ref(db, `users/${currentUser.uid}/addresses`), s => { 
                const myAddr = document.getElementById('address-list-container');
                const delAddr = document.getElementById('delivery-address-list'); 
                myAddr.innerHTML = ''; delAddr.innerHTML = ''; 
                if (!s.exists()) { 
                    const msg = '<p class="empty-cart">No saved addresses.</p>'; 
                    myAddr.innerHTML = msg; 
                    delAddr.innerHTML = msg; 
                    return; 
                } 
                let first = true;
                s.forEach(c => { 
                    const id = c.key, a = c.val(); 
                    const myAddrDetailsHTML = `<div class="address-details"><strong>${a.name}</strong><p>${a.area}, ${a.village}, ${a.district} - ${a.pincode}</p><p>Mobile: +91 ${a.mobile}</p></div> <button class="btn danger-btn" data-address-id="${id}" style="margin-top:10px; font-size:14px; padding: 8px;">Delete</button>`;
                    myAddr.innerHTML += `<div class="address-card" style="display:block;">${myAddrDetailsHTML}</div>`;
                    
                    const delAddrDetailsHTML = `<label for="addr-${id}" class="address-card"><input type="radio" name="delivery-address" id="addr-${id}" data-address-id="${id}" ${first ? 'checked' : ''}><div class="address-details"><strong>${a.name}</strong><p>${a.area}, ${a.village}, ${a.district} - ${a.pincode}</p><p>Mobile: +91 ${a.mobile}</p></div></label>`;
                    delAddr.innerHTML += delAddrDetailsHTML;
                    first = false;
                }); 
            }); 
        }

        function handleDeleteAddress(addressId) { showDialog({ type: 'confirm', title: "Delete Address", message: "Are you sure you want to delete this address?", primaryBtnText: "Delete", onPrimaryClick: () => { set(ref(db, `users/${currentUser.uid}/addresses/${addressId}`), null) }, secondaryBtnText: "Cancel" }); };
        document.getElementById('addr-pincode').addEventListener('blur', async (e) => { const pincode = e.target.value; if (pincode.length === 6) { try { const response = await fetch(`https://api.postalpincode.in/pincode/${pincode}`); const data = await response.json(); if (data && data[0].Status === 'Success') { const info = data[0].PostOffice[0]; document.getElementById('addr-district').value = info.District; document.getElementById('addr-state').value = info.State; } else { alert('Invalid Pincode.'); } } catch (err) { console.error("Pincode API error", err); } } });
        
        document.getElementById('buy-now-btn').addEventListener('click', () => { showScreen('delivery-address-screen'); });
        document.querySelectorAll('.payment-option').forEach(el => { el.addEventListener('click', e => { document.querySelectorAll('.payment-option').forEach(o => o.classList.remove('selected')); el.classList.add('selected'); }); });
        
        document.getElementById('submit-order-btn').addEventListener('click', async () => { 
            const btn = document.getElementById('submit-order-btn');
            btn.disabled = true; btn.textContent = 'Placing Order...';

            try { 
                const selectedAddrRadio = document.querySelector('#delivery-address-list input[name="delivery-address"]:checked'); 
                if (!selectedAddrRadio) {
                    alert('Please select a delivery address.');
                    btn.disabled = false; btn.textContent = 'Place Order';
                    return; 
                }
                const addressId = selectedAddrRadio.dataset.addressId; 
                const addressSnap = await get(ref(db, `users/${currentUser.uid}/addresses/${addressId}`)); 
                if (!addressSnap.exists()) {
                    alert('Selected address not found.');
                    btn.disabled = false; btn.textContent = 'Place Order';
                    return;
                }
                const cartSnap = await get(ref(db, `carts/${currentUser.uid}`)); 
                if(!cartSnap.exists()) {
                    alert("Your cart is empty!");
                    btn.disabled = false; btn.textContent = 'Place Order';
                    return;
                }
                const paymentMode = document.querySelector('.payment-option.selected').dataset.value; 
                let total = 0; Object.values(cartSnap.val()).forEach(i => total += (i.price || 0) * (i.quantity || 1)); 
                const orderData = { userId: currentUser.uid, items: cartSnap.val(), address: addressSnap.val(), totalAmount: total, paymentMode: paymentMode, status: 'Order Placed', orderDate: new Date().toISOString() }; 
                
                if (paymentMode === 'ONLINE') {
                    const options = {
                        "key": "YOUR_RAZORPAY_KEY_ID", // अपना Razorpay Key ID डालें
                        "amount": total * 100,
                        "currency": "INR",
                        "name": "Qadri Shop",
                        "description": "Order Payment",
                        "handler": async function (response){
                            orderData.status = 'Paid, Order Placed';
                            orderData.razorpay_payment_id = response.razorpay_payment_id;
                            const newOrderRef = push(ref(db, 'orders')); 
                            await set(newOrderRef, orderData); 
                            await set(ref(db, `carts/${currentUser.uid}`), null); 
                            showDialog({ type: 'success', title: "Payment Success!", message: "Your order has been placed.", primaryBtnText: "View Orders", onPrimaryClick: () => { showScreen('my-orders-screen'); switchOrderTab('active'); } }); 
                        },
                        "prefill": {
                            "name": addressSnap.val().name,
                            "email": currentUser.email,
                            "contact": addressSnap.val().mobile
                        },
                        "theme": {
                            "color": "#3399cc"
                        }
                    };
                    const rzp1 = new Razorpay(options);
                    rzp1.on('payment.failed', function (response){
                        alert('Payment Failed: ' + response.error.description);
                    });
                    rzp1.open();
                } else {
                    const newOrderRef = push(ref(db, 'orders')); 
                    await set(newOrderRef, orderData); 
                    await set(ref(db, `carts/${currentUser.uid}`), null); 
                    showDialog({ type: 'success', title: "Order Confirmed!", message: "Your order has been placed successfully.", primaryBtnText: "View My Orders", onPrimaryClick: () => { showScreen('my-orders-screen'); switchOrderTab('active'); } }); 
                }

            } catch (err) { 
                console.error(err); 
                alert("Order placement failed: " + err.message); 
            } finally {
                btn.disabled = false; 
                btn.textContent = 'Place Order';
            }
        });
        
        window.switchOrderTab = (tab) => { document.querySelectorAll('.tab-item, .order-list').forEach(el => el.classList.remove('active')); document.getElementById(`${tab}-orders-tab`).classList.add('active'); document.getElementById(`${tab}-orders-list`).classList.add('active'); };
        
        function loadMyOrders() { 
            if (!currentUser) return; 
            const q = query(ref(db, 'orders'), orderByChild('userId'), equalTo(currentUser.uid)); 
            onValue(q, s => { 
                const active = [], history = []; 
                if (s.exists()) { 
                    s.forEach(c => { 
                        const order = { key: c.key, ...c.val() }; 
                        (['Cancelled', 'Delivered'].includes(order.status) ? history : active).push(order); 
                    }); 
                } 
                renderOrderList(active.sort((a,b)=>new Date(b.orderDate)-new Date(a.orderDate)), 'active-orders-list'); 
                renderOrderList(history.sort((a,b)=>new Date(b.orderDate)-new Date(a.orderDate)), 'history-orders-list'); 
            }); 
        }
        
        function renderOrderList(list, contId) { 
            const cont = document.getElementById(contId); 
            cont.innerHTML = ''; 
            if (contId === 'history-orders-list' && list.length > 0) { 
                cont.innerHTML += `<button id="clear-history-btn" class="btn danger-btn" style="margin: 0 0 15px; width: 100%;">Clear History</button>`; 
            } 
            if (list.length === 0) { 
                cont.innerHTML = `<p class="empty-cart">No orders here.</p>`; 
                return; 
            } 
            list.forEach(order => { 
                const card = document.createElement('div'); 
                card.className = 'order-card'; 
                const isCancellable = order.status === 'Order Placed'; 
                const firstItem = Object.values(order.items)[0];
                const statusPlaced = ['Order Placed', 'Paid, Order Placed'].includes(order.status);
                const statusDispatched = ['Dispatched', 'Delivered'].includes(order.status);
                const statusDelivered = ['Delivered'].includes(order.status);
                
                let statusTrackerHTML = `
                <div class="order-status-tracker">
                    <div class="status-step ${statusPlaced ? 'active' : ''}">
                        <div class="status-dot"></div>
                        <div class="status-label">Order Placed</div>
                    </div>
                    <div class="status-step ${statusDispatched ? 'active' : ''}">
                        <div class="status-dot"></div>
                        <div class="status-label">Dispatched</div>
                    </div>
                    <div class="status-step ${statusDelivered ? 'active' : ''}">
                        <div class="status-dot"></div>
                        <div class="status-label">Delivered</div>
                    </div>
                </div>`;

                if (order.status === 'Cancelled') {
                    statusTrackerHTML = `<p style="text-align:center; color: var(--danger-color); font-weight: bold; margin-top: 15px;">Order Cancelled</p>`;
                }

                // Make sure 'key' is defined before using it
                const orderKey = order.key; 
                card.innerHTML = `
                    <div class="order-card-header">
                        <span class="order-id">Order #${orderKey ? orderKey.slice(-6).toUpperCase() : 'N/A'}</span>
                        <span>${new Date(order.orderDate).toLocaleDateString()}</span>
                    </div>
                    <div class="order-card-body">
                        <img src="${firstItem.imageUrls[0]}">
                        <div class="order-card-details">
                            <h4>${firstItem.title}</h4>
                            <p>Total: ₹${order.totalAmount}</p>
                        </div>
                    </div>
                    ${statusTrackerHTML}
                    ${isCancellable ? `<div class="order-card-footer"><button class="order-cancel-btn" data-order-id="${orderKey}">Cancel Order</button></div>` : ''}`;
                
                cont.appendChild(card); 
            }); 
            const clearBtn = document.getElementById('clear-history-btn'); 
            if (clearBtn) clearBtn.onclick = handleClearHistory; 
            cont.querySelectorAll('.order-cancel-btn').forEach(btn => btn.onclick = () => handleCancelOrder(btn.dataset.orderId)); 
        }

        function handleCancelOrder(id) { showDialog({ type: 'confirm', title: "Cancel Order", message: "Are you sure you want to cancel this order?", primaryBtnText: "Yes, Cancel", onPrimaryClick: () => { update(ref(db, `orders/${id}`), { status: 'Cancelled' }).catch(err => alert("Could not cancel order. Error: "+err.message)) }, secondaryBtnText: "No" }); }
        async function handleClearHistory() { showDialog({ type: 'confirm', title: "Clear History", message: "This will permanently delete your history. Are you sure?", primaryBtnText: "Clear All", onPrimaryClick: async () => { try { const q = query(ref(db, 'orders'), orderByChild('userId'), equalTo(currentUser.uid)); const snapshot = await get(q); const updates = {}; snapshot.forEach(c => { const order = c.val(); if (['Cancelled', 'Delivered'].includes(order.status)) { updates[`/orders/${c.key}`] = null; } }); await update(ref(db), updates); } catch(err) { alert("Could not clear history: " + err.message); } }, secondaryBtnText: "Cancel" }); }

        function applyFiltersAndSort(category = null) {
            let filtered = {};
            // If a category is specified and it's not null, filter by it
            if (category !== null) {
                for (const id in allProducts) {
                    if (allProducts[id].category === category) {
                        filtered[id] = allProducts[id];
                    }
                }
            } else { // Otherwise, consider all products
                filtered = { ...allProducts };
            }
            
            const searchTerm = currentFilters.search.toLowerCase();
            if (searchTerm) {
                const searchResults = {};
                for (const id in filtered) {
                    if (filtered[id].title.toLowerCase().includes(searchTerm)) {
                        searchResults[id] = filtered[id];
                    }
                }
                filtered = searchResults;
            }
            
            let sortedArray = Object.entries(filtered);
            if (currentFilters.sort === 'price_asc') {
                sortedArray.sort(([,a], [,b]) => a.price - b.price);
            } else if (currentFilters.sort === 'price_desc') {
                sortedArray.sort(([,a], [,b]) => b.price - a.price);
            }
            const sortedProducts = Object.fromEntries(sortedArray);
            renderProducts(sortedProducts);
        }
        function filterProductsByCategory(catName) { 
            currentFilters.category = catName; // Set the current category filter
            applyFiltersAndSort(currentFilters.category); // Pass the category to applyFiltersAndSort
            showScreen('home-screen'); 
        }
        document.getElementById('search-bar').addEventListener('input', e => { currentFilters.search = e.target.value; applyFiltersAndSort(); });
        document.getElementById('sort-filter').addEventListener('change', e => { currentFilters.sort = e.target.value; applyFiltersAndSort(); });
        
        document.getElementById('product-grid').addEventListener('click', e => { 
            const favIcon = e.target.closest('.fav-icon'); 
            const imgContainer = e.target.closest('.product-image-container');
            if (favIcon) { 
                e.stopPropagation(); 
                toggleFavorite(favIcon.dataset.productId); 
            } else if (imgContainer) { 
                const id = imgContainer.dataset.productId; 
                showProductDetails(id, allProducts[id]); 
            } 
        });
        document.getElementById('favorites-grid').addEventListener('click', e => { 
            const favIcon = e.target.closest('.fav-icon'); 
            const imgContainer = e.target.closest('.product-image-container');
            if (favIcon) { 
                e.stopPropagation(); 
                toggleFavorite(favIcon.dataset.productId).then(loadAndShowFavoritesScreen); 
            } else if (imgContainer) { 
                const id = imgContainer.dataset.productId; 
                showProductDetails(id, allProducts[id]); 
            } 
        });
        document.getElementById('address-list-container').addEventListener('click', e => { 
            const delBtn = e.target.closest('.danger-btn'); 
            if(delBtn) { 
                handleDeleteAddress(delBtn.dataset.addressId); 
            } 
        });
        document.querySelectorAll('.back-icon').forEach(btn => { 
            btn.addEventListener('click', (e) => { 
                const currentScreenId = e.target.closest('.screen').id; 
                if (currentScreenId === 'add-address-screen') { 
                    showScreen(addressReturnScreen); 
                } else if (currentScreenId === 'address-screen') { 
                    showScreen('profile-screen'); 
                } else if (['my-orders-screen', 'edit-profile-screen', 'favorites-screen'].includes(currentScreenId)) { 
                    showScreen('profile-screen'); 
                } else if (currentScreenId === 'delivery-address-screen') { 
                    showScreen('cart-screen'); 
                } else { 
                    showScreen('home-screen'); 
                } 
            }); 
        });
        document.getElementById('profile-my-orders').addEventListener('click', () => { if(currentUser) { showScreen('my-orders-screen'); } else { alert("Please login to see your orders."); } });
        document.getElementById('profile-my-favorites').addEventListener('click', () => { if(currentUser) { loadAndShowFavoritesScreen(); } else { alert("Please login to see your favorites."); } });
        document.getElementById('profile-my-addresses').addEventListener('click', () => { if(currentUser) { openAddressScreen('profile-screen'); } else { alert("Please login to manage addresses."); } });
        document.getElementById('profile-edit-profile').addEventListener('click', () => { if(currentUser) { loadUserProfileForEdit(); showScreen('edit-profile-screen'); } else { alert("Please login to edit your profile."); } });
        document.getElementById('add-new-address-btn1').addEventListener('click', () => openAddAddressScreen('address-screen'));
        document.getElementById('add-new-address-btn2').addEventListener('click', () => openAddAddressScreen('delivery-address-screen'));
    </script>
</body>
</html>
